<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Numbering - ENI Project</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Aptos', 'Segoe UI', Tahoma, sans-serif; background: #fff; padding: 20px; color: #000; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; padding: 30px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; }
        .header h1 { color: #00049E; font-size: 28px; margin-bottom: 8px; }
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; max-height: 85vh; overflow-y: auto; }
        .card h2 { color: #00049E; margin-bottom: 20px; font-size: 20px; }
        .form-group { margin-bottom: 18px; }
        label { display: block; font-weight: bold; margin-bottom: 6px; font-size: 14px; }
        select, input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; }
        select:focus, input:focus { outline: none; border-color: #00049E; }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: all 0.3s; }
        .btn-preview { background: #0ea5e9; color: white; }
        .btn-preview:hover { background: #0284c7; }
        .btn-confirm { background: #10b981; color: white; display: none; }
        .btn-confirm:hover { background: #059669; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
        
        .preview-badge { 
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #78350f; 
            padding: 12px 20px; 
            border-radius: 8px; 
            font-size: 13px; 
            font-weight: bold; 
            text-align: center; 
            margin-bottom: 15px;
            border: 2px solid #f59e0b;
            display: none;
        }
        
        .output-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; margin-bottom: 15px; }
        .output-card h3 { color: #00049E; margin-bottom: 12px; font-size: 16px; }
        .output-display { display: flex; gap: 8px; }
        .output-display input { flex: 1; background: #f5f5f5; font-family: monospace; font-size: 14px; padding: 10px; border-radius: 6px; border: 1px solid #ddd; }
        .copy-btn { padding: 10px 18px; background: #00049E; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; white-space: nowrap; }
        .copy-btn:hover { background: #000378; }
        .success { color: #10b981; font-size: 11px; margin-top: 4px; font-weight: bold; text-align: center; }
        .warning-box { background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 12px; margin-top: 12px; font-size: 13px; color: #92400e; }
        .warning-box strong { color: #b45309; }
        .info-card { background: #00049E; color: white; padding: 20px; border-radius: 15px; margin-top: 15px; }
        .info-card h3 { color: white; margin-bottom: 10px; font-size: 16px; }
        .info-card p { font-size: 13px; line-height: 1.5; }
        
        /* Email Verification Overlay */
        .email-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.7); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 9999;
        }
        .email-box { 
            background: white; 
            padding: 40px; 
            border-radius: 15px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); 
            max-width: 500px; 
            width: 90%;
        }
        .email-box h2 { color: #00049E; margin-bottom: 10px; font-size: 24px; }
        .email-box p { color: #666; margin-bottom: 20px; font-size: 14px; }
        .email-input { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 16px; 
            margin-bottom: 15px;
        }
        .email-input:focus { outline: none; border-color: #00049E; }
        .btn-verify { 
            width: 100%; 
            padding: 14px; 
            background: #00049E; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer;
        }
        .btn-verify:hover { background: #000378; }
        .error-msg { 
            color: #dc2626; 
            font-size: 13px; 
            margin-top: 10px; 
            display: none;
        }
        .verified-badge {
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        .footer { text-align: center; margin-top: 30px; color: #999; font-size: 11px; }
        
        /* Responsive Design */
        @media (max-width: 1024px) { 
            .main-grid { grid-template-columns: 1fr; }
            .card { max-height: none; }
        }
        
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header { padding: 20px; }
            .header h1 { font-size: 22px; }
            .card { padding: 20px; }
            .card h2 { font-size: 18px; }
            select, input { font-size: 16px; } /* Prevent zoom on iOS */
            .btn { padding: 16px; font-size: 18px; }
            .output-display { flex-direction: column; }
            .copy-btn { width: 100%; padding: 12px; }
        }
        
        @media (max-width: 480px) {
            .header h1 { font-size: 20px; }
            .header p { font-size: 13px; }
            .form-group { margin-bottom: 15px; }
        }
    </style>
</head>
<body>
    <!-- Email Verification Overlay -->
    <div id="emailOverlay" class="email-overlay">
        <div class="email-box">
            <h2>üîí Email Verification</h2>
            <p>Please enter your company email to access this system</p>
            <input type="email" id="emailInput" class="email-input" placeholder="your.email@company.com" />
            <button class="btn-verify" onclick="verifyEmail()">Verify Email</button>
            <p id="errorMsg" class="error-msg">‚ùå Access denied. Invalid email address.</p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üìÑ Document Numbering <span id="verifiedBadge" class="verified-badge" style="display:none;">‚úì Verified</span></h1>
            <p>ENI Project - Provision of Technical and Process Safety Studies, Assessment and Support Services</p>
            <p style="font-size: 12px; color: #666; margin-top: 5px;">Logged in as: <strong id="userEmail"></strong></p>
        </div>

        <div class="main-grid">
            <div class="card">
                <h2>Input Parameters</h2>
                
                <div class="form-group">
                    <label>Sub-Facility</label>
                    <select id="subFacility" onchange="updateCategory()">
                        <option value="" disabled selected>-- Select Sub-Facility --</option>
                        <option value="00">00 - General / Others</option>
                        <option value="01">01 - FPU</option>
                        <option value="02">02 - RFI</option>
                        <option value="03">03 - SPS</option>
                        <option value="04">04 - JKK - Telcom System Caprock</option>
                        <option value="05">05 - JKK - Telcom Rental Equipt Compnet</option>
                        <option value="06">06 - JKK - Telcom Rental Jasnikom</option>
                        <option value="10">10 - JKK - GnG Merakes / Merakes EPCI-1</option>
                        <option value="11">11 - MERAKES EPCI-4</option>
                        <option value="12">12 - MERAKES EP-3 / MERAKES EPCI-2</option>
                        <option value="13">13 - Telford (MKS EPCI-1)</option>
                        <option value="14">14 - Maha</option>
                        <option value="20">20 - Merakes East</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Phase</label>
                    <select id="phase">
                        <option value="" disabled selected>-- Select Phase --</option>
                        <option value="F">F - Feasibility Study</option>
                        <option value="B">B - Basic / FEED</option>
                        <option value="C">C - Construction</option>
                        <option value="D">D - Detail</option>
                        <option value="P">P - Production</option>
                        <option value="G">G - Decommissioning</option>
                        <option value="H">H - Abandonment</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Discipline</label>
                    <select id="discipline">
                        <option value="" disabled selected>-- Select Discipline --</option>
                        <option value="A">A - Civil & Architectural</option>
                        <option value="B">B - Quality Assurance & Control</option>
                        <option value="C">C - Telecommunications</option>
                        <option value="D">D - Reserved</option>
                        <option value="E">E - Electrical</option>
                        <option value="F">F - HSE (Health Safety & Environmental)</option>
                        <option value="G">G - Interdiscipline & Miscellaneous</option>
                        <option value="H">H - Logistic</option>
                        <option value="I">I - Instrumentation, Control & Automation</option>
                        <option value="J">J - Construction & Erection/Installation</option>
                        <option value="K">K - Maintenance</option>
                        <option value="L">L - Pipeline</option>
                        <option value="M">M - Machinery Packages</option>
                        <option value="N">N - Naval & Floating Platform</option>
                        <option value="O">O - Offshore Fixed Platform</option>
                        <option value="P">P - Process</option>
                        <option value="Q">Q - Reserved</option>
                        <option value="R">R - Research & Technological Innovation</option>
                        <option value="S">S - Offshore Pipelines (Sealines)</option>
                        <option value="T">T - Plant Layout & Piping</option>
                        <option value="U">U - Subsea Systems</option>
                        <option value="V">V - Mechanical Equipment</option>
                        <option value="W">W - Commissioning and Test Run</option>
                        <option value="X">X - Material, Corrosion, Welding, Painting & Insulation</option>
                        <option value="Y">Y - Marine</option>
                        <option value="Z">Z - Decommissioning</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Document Type</label>
                    <select id="docType">
                        <option value="" disabled selected>-- Select Document Type --</option>
                        <option value="CA">CA - Generic Calculation</option>
                        <option value="CB">CB - Calculation Procedure</option>
                        <option value="CC">CC - Calculation of Reinforced Concrete Foundations</option>
                        <option value="CD">CD - Design Calculation</option>
                        <option value="CE">CE - Electrical Calculation</option>
                        <option value="CF">CF - RAM Analysis</option>
                        <option value="CG">CG - PSV Calculation & Sizing</option>
                        <option value="CH">CH - HVAC Calculation</option>
                        <option value="DA">DA - Equipment, Assembly and Outline Drawings</option>
                        <option value="DB">DB - Drawing of Reinforced Concrete Structure</option>
                        <option value="DC">DC - Construction Drawing of Equipment</option>
                        <option value="DD">DD - Layout Diagram</option>
                        <option value="DI">DI - Isometric Drawing</option>
                        <option value="EA">EA - Equipment List</option>
                        <option value="EB">EB - Material Take Off</option>
                        <option value="FA">FA - General Diagram</option>
                        <option value="FB">FB - Block Diagram</option>
                        <option value="FM">FM - Piping and Instrumentation Diagram (P&ID)</option>
                        <option value="RA">RA - Technical Study</option>
                        <option value="RB">RB - Project/Design Premises Report</option>
                        <option value="RI">RI - HAZID / HAZOP Report</option>
                        <option value="SA">SA - Construction Specification</option>
                        <option value="SB">SB - Commissioning Specification</option>
                        <option value="ST">ST - Technical Specification</option>
                        <option value="TA">TA - Software Specification</option>
                        <option value="TB">TB - Software Functional Specification</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Revision Status</label>
                    <select id="revStatus">
                        <option value="" disabled selected>-- Select Revision Status --</option>
                        <option value="EVFS">EV-FS - Evaluation for Feasibility Study</option>
                        <option value="CSFS">CS-FS - Concept Selection for Feasibility Study</option>
                        <option value="CDBF">CD-BF - Concept Definition for Basic</option>
                        <option value="CDFE">CD-FE - Concept Definition for Feed</option>
                        <option value="EXDE">EX-DE - Execution for Detail</option>
                        <option value="EXCO">EX-CO - Execution for Construction</option>
                        <option value="EXAB">EX-AB - Execution As Built</option>
                        <option value="PRCO">PR-CO - Production Commissioning</option>
                        <option value="PROP">PR-OP - Production Operation</option>
                        <option value="PDDF">PD-DF - Decommissioning Project Definition</option>
                        <option value="PEDT">PE-DT - Decommissioning Project Execution - Detail</option>
                        <option value="PEDI">PE-DI - Decommissioning Project Execution - Removal</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Page Count</label>
                    <input type="number" id="pageCount" placeholder="e.g. 24" onkeypress="if(event.key==='Enter') preview()">
                </div>

                <div class="form-group">
                    <label>Internal Category</label>
                    <select id="category" onchange="checkWarning()">
                        <option value="" disabled selected>-- Select Internal Category --</option>
                        <option value="A">A - Kadal</option>
                        <option value="B">B - Merakes East</option>
                        <option value="C">C - Jangkrik North East (JNE)</option>
                        <option value="D">D - Konta</option>
                        <option value="E">E - Merakes-4 (MKS-4)</option>
                        <option value="F">F - Merakes-7 (MKS-7)</option>
                        <option value="G">G - Maha</option>
                    </select>
                </div>

                <div id="warning" class="warning-box" style="display: none;">
                    <strong>‚ö†Ô∏è Warning:</strong>
                    <p id="warningText"></p>
                </div>

                <button class="btn btn-preview" onclick="preview()">üîç Preview Document Numbers</button>
                <button id="confirmBtn" class="btn btn-confirm" onclick="confirmAndSave()">‚úÖ Confirm & Save to Database</button>
            </div>

            <div class="card">
                <h2>Generated Outputs</h2>
                
                <div id="previewBadge" class="preview-badge">
                    ‚ö†Ô∏è PREVIEW MODE - Numbers not saved yet. Click "Confirm & Save" to record.
                </div>
                
                <div class="output-card">
                    <h3>Document Name</h3>
                    <div class="output-display">
                        <input type="text" id="out1" readonly placeholder="Will be generated...">
                        <button class="copy-btn" onclick="copy(1)">üìã Copy</button>
                    </div>
                    <div id="msg1" class="success"></div>
                </div>

                <div class="output-card">
                    <h3>File Name for Client</h3>
                    <div class="output-display">
                        <input type="text" id="out2" readonly placeholder="Will be generated...">
                        <button class="copy-btn" onclick="copy(2)">üìã Copy</button>
                    </div>
                    <div id="msg2" class="success"></div>
                </div>

                <div class="output-card">
                    <h3>Internal Document Numbering</h3>
                    <div class="output-display">
                        <input type="text" id="out3" readonly placeholder="Will be generated...">
                        <button class="copy-btn" onclick="copy(3)">üìã Copy</button>
                    </div>
                    <div id="msg3" class="success"></div>
                </div>

                <div class="info-card">
                    <h3>üí° How It Works</h3>
                    <p>‚Ä¢ <strong>Preview</strong> - Check your numbers before saving<br>
                    ‚Ä¢ <strong>Confirm & Save</strong> - Records to database & increments counter<br>
                    ‚Ä¢ <strong>No duplicates</strong> - Counter only increments after confirmation</p>
                </div>
            </div>
        </div>

        <div class="footer">DS</div>
    </div>

    <script>
        // Google Sheets API URL
        const API_URL = 'https://script.google.com/macros/s/AKfycby9cO6NONVBf6z5Ze43RK4bsCYfH2z_VPgDvXIUwfg7ei9pymMwbD6dC58jYPojyGPIGA/exec';
        
        let counters = {A:7, B:7, C:3, D:5, E:9, F:6, G:5, H:1}; // Fallback values
        let isPreviewMode = false;
        let userEmail = '';
        let isVerified = false;
        let isLoading = false;
        
        // Load counters from Google Sheets on page load
        async function loadCounters() {
            try {
                const response = await fetch(`${API_URL}?action=getCounters`);
                const result = await response.json();
                
                if (result.success) {
                    counters = result.data;
                    console.log('‚úÖ Counters loaded from Google Sheets:', counters);
                } else {
                    console.warn('‚ö†Ô∏è Using fallback counters');
                }
            } catch (error) {
                console.error('‚ùå Error loading counters:', error);
                console.warn('‚ö†Ô∏è Using fallback counters');
            }
        }
        
        // Email Verification Function
        function verifyEmail() {
            const email = document.getElementById('emailInput').value.trim().toLowerCase();
            const errorMsg = document.getElementById('errorMsg');
            
            if (!email) {
                errorMsg.textContent = '‚ùå Please enter your email address.';
                errorMsg.style.display = 'block';
                return;
            }
            
            // Check if email ends with @bureauveritas.com
            if (email.endsWith('@bureauveritas.com')) {
                // Access granted
                userEmail = email;
                isVerified = true;
                
                // Hide overlay
                document.getElementById('emailOverlay').style.display = 'none';
                
                // Show verified badge
                document.getElementById('verifiedBadge').style.display = 'inline-block';
                document.getElementById('userEmail').textContent = userEmail;
                
                // Store in session
                sessionStorage.setItem('verifiedEmail', userEmail);
                
                // Load counters from Google Sheets
                loadCounters();
            } else {
                // Access denied
                errorMsg.textContent = '‚ùå Access denied. Invalid email address.';
                errorMsg.style.display = 'block';
                document.getElementById('emailInput').value = '';
                document.getElementById('emailInput').focus();
            }
        }
        
        // Check if already verified (session)
        window.onload = function() {
            const storedEmail = sessionStorage.getItem('verifiedEmail');
            if (storedEmail && storedEmail.endsWith('@bureauveritas.com')) {
                userEmail = storedEmail;
                isVerified = true;
                document.getElementById('emailOverlay').style.display = 'none';
                document.getElementById('verifiedBadge').style.display = 'inline-block';
                document.getElementById('userEmail').textContent = userEmail;
                
                // Load counters from Google Sheets
                loadCounters();
            }
        };
        
        // Allow Enter key to submit
        document.addEventListener('DOMContentLoaded', function() {
            const emailInput = document.getElementById('emailInput');
            if (emailInput) {
                emailInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        verifyEmail();
                    }
                });
            }
        });
        
        function updateCategory() {
            const sf = document.getElementById('subFacility').value;
            const map = {'20':'B', '11':'E', '14':'G'};
            const cat = map[sf] || 'A';
            document.getElementById('category').value = cat;
            checkWarning();
        }
        
        function checkWarning() {
            const sf = document.getElementById('subFacility').value;
            const cat = document.getElementById('category').value;
            const warn = document.getElementById('warning');
            const text = document.getElementById('warningText');
            
            const expected = {'20':'B', '11':'E', '14':'G'};
            if(expected[sf] && expected[sf] !== cat) {
                warn.style.display = 'block';
                text.textContent = 'Sub-facility and category mismatch. Please verify this is correct.';
            } else {
                warn.style.display = 'none';
            }
        }
        
        function preview() {
            // Check if verified
            if (!isVerified) {
                alert('‚ö†Ô∏è Please verify your email first!');
                return;
            }
            
            const sf = document.getElementById('subFacility').value;
            const ph = document.getElementById('phase').value;
            const ds = document.getElementById('discipline').value;
            const dt = document.getElementById('docType').value;
            const rv = document.getElementById('revStatus').value;
            const pg = document.getElementById('pageCount').value;
            const cat = document.getElementById('category').value;
            
            if(!sf || !ph || !ds || !dt || !rv || !pg || !cat) {
                alert('‚ö†Ô∏è Please fill in all required fields!');
                return;
            }
            
            // Generate preview (WITHOUT incrementing counter)
            const nextNum = counters[cat] + 1;
            const docNum = `2208${sf}${ph}${ds}${dt}00001`;
            const fileName = `${docNum}_${rv}00_${pg}`;
            const internal = `IN-2208-${sf}-P0Y-ENI-${cat}${String(nextNum).padStart(4,'0')}`;
            
            document.getElementById('out1').value = docNum;
            document.getElementById('out2').value = fileName;
            document.getElementById('out3').value = internal;
            
            // Show preview mode badge and confirm button
            document.getElementById('previewBadge').style.display = 'block';
            document.getElementById('confirmBtn').style.display = 'block';
            isPreviewMode = true;
            
            alert('üîç Preview Generated! Review the numbers and click "Confirm & Save" if correct.');
        }
        
        async function confirmAndSave() {
            if(!isPreviewMode) {
                alert('‚ö†Ô∏è Please preview first!');
                return;
            }
            
            if (!isVerified) {
                alert('‚ö†Ô∏è Please verify your email first!');
                return;
            }
            
            if (isLoading) {
                alert('‚è≥ Please wait, saving...');
                return;
            }
            
            // Disable button and show loading
            isLoading = true;
            const confirmBtn = document.getElementById('confirmBtn');
            const originalText = confirmBtn.textContent;
            confirmBtn.textContent = '‚è≥ Saving to Database...';
            confirmBtn.disabled = true;
            
            try {
                // Get all form data
                const formData = {
                    action: 'generate',
                    email: userEmail,
                    subFacility: document.getElementById('subFacility').value,
                    phase: document.getElementById('phase').value,
                    discipline: document.getElementById('discipline').value,
                    docType: document.getElementById('docType').value,
                    revStatus: document.getElementById('revStatus').value,
                    pageCount: document.getElementById('pageCount').value,
                    category: document.getElementById('category').value
                };
                
                // Send to Google Sheets
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update local counter
                    counters[formData.category] = result.data.counter;
                    
                    // Update outputs with actual saved values
                    document.getElementById('out1').value = result.data.docName;
                    document.getElementById('out2').value = result.data.fileName;
                    document.getElementById('out3').value = result.data.internal;
                    
                    // Hide preview badge and confirm button
                    document.getElementById('previewBadge').style.display = 'none';
                    confirmBtn.style.display = 'none';
                    isPreviewMode = false;
                    
                    alert(`‚úÖ Saved successfully!\n\nGenerated by: ${userEmail}\nInternal number: ${result.data.internal}\n\nRecorded to Google Sheets database.`);
                } else {
                    throw new Error(result.message || 'Save failed');
                }
                
            } catch (error) {
                console.error('‚ùå Error saving to database:', error);
                alert(`‚ùå Error saving to database: ${error.message}\n\nPlease try again or contact admin.`);
                
                // Re-enable button
                confirmBtn.textContent = originalText;
                confirmBtn.disabled = false;
            } finally {
                isLoading = false;
                if (confirmBtn.style.display !== 'none') {
                    confirmBtn.textContent = originalText;
                    confirmBtn.disabled = false;
                }
            }
        }
        
        function copy(n) {
            const inp = document.getElementById('out'+n);
            if(!inp.value) { alert('‚ö†Ô∏è Generate first!'); return; }
            inp.select();
            document.execCommand('copy');
            const msg = document.getElementById('msg'+n);
            msg.textContent = '‚úì Copied!';
            setTimeout(() => msg.textContent = '', 2000);
        }
    </script>
</body>
</html>
