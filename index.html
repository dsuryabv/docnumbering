<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document & Transmittal Generator - ENI Project</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; color: #212529; line-height: 1.6; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        /* Header */
        .header { background: linear-gradient(135deg, #00049E 0%, #000378 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header h1 { font-size: 32px; margin-bottom: 8px; display: flex; align-items: center; gap: 15px; }
        .header p { opacity: 0.95; font-size: 14px; }
        .user-info { font-size: 13px; margin-top: 10px; opacity: 0.9; }
        .verified-badge { background: #10b981; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        
        /* Email Verification Overlay */
        .email-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .email-box { background: white; padding: 50px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 480px; width: 90%; }
        .email-box h2 { color: #00049E; font-size: 28px; margin-bottom: 15px; }
        .email-box p { color: #6c757d; margin-bottom: 25px; }
        .email-input { width: 100%; padding: 14px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px; margin-bottom: 20px; transition: border-color 0.3s; }
        .email-input:focus { outline: none; border-color: #00049E; }
        .btn-verify { width: 100%; padding: 16px; background: #00049E; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.3s; }
        .btn-verify:hover { background: #000378; }
        .error-msg { color: #dc3545; font-size: 14px; margin-top: 12px; display: none; font-weight: 500; }
        
        /* Main Grid */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        
        /* Cards */
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .card h2 { color: #00049E; font-size: 22px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #e9ecef; }
        
        /* Form Groups */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #495057; font-size: 14px; }
        .form-group select,
        .form-group input,
        .form-group textarea { 
            width: 100%; 
            padding: 12px 14px; 
            border: 2px solid #dee2e6; 
            border-radius: 8px; 
            font-size: 15px; 
            font-family: inherit; 
            transition: all 0.3s;
            background: white;
        }
        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus { 
            outline: none; 
            border-color: #00049E; 
            box-shadow: 0 0 0 3px rgba(0,4,158,0.1);
        }
        .form-group select:disabled,
        .form-group input:disabled { 
            background: #e9ecef; 
            color: #6c757d; 
            cursor: not-allowed; 
        }
        .form-group textarea { min-height: 90px; resize: vertical; }
        
        /* Buttons */
        .btn { width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-top: 12px; }
        .btn-preview { background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white; box-shadow: 0 4px 12px rgba(14,165,233,0.3); }
        .btn-preview:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(14,165,233,0.4); }
        .btn-confirm { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; display: none; box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
        .btn-confirm:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(16,185,129,0.4); }
        
        /* Preview Badge */
        .preview-badge { 
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); 
            color: #78350f; 
            padding: 14px 20px; 
            border-radius: 10px; 
            font-size: 14px; 
            font-weight: 600; 
            text-align: center; 
            margin-bottom: 20px; 
            display: none;
            box-shadow: 0 2px 8px rgba(251,191,36,0.3);
        }
        
        /* Output Cards */
        .output-card { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 18px; border: 2px solid #e9ecef; }
        .output-card h3 { color: #00049E; font-size: 15px; margin-bottom: 12px; font-weight: 600; }
        .output-display { display: flex; gap: 10px; }
        .output-display input { flex: 1; background: white; font-family: 'Courier New', monospace; font-size: 14px; padding: 12px; border: 2px solid #dee2e6; border-radius: 6px; }
        .copy-btn { padding: 12px 18px; background: #00049E; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s; }
        .copy-btn:hover { background: #000378; transform: scale(1.05); }
        .success { color: #10b981; font-size: 12px; margin-top: 6px; font-weight: 600; text-align: center; }
        
        /* Info Card */
        .info-card { background: linear-gradient(135deg, #00049E 0%, #000378 100%); color: white; padding: 25px; border-radius: 10px; margin-top: 20px; }
        .info-card h3 { color: white; margin-bottom: 12px; font-size: 17px; }
        .info-card p { font-size: 14px; line-height: 1.8; opacity: 0.95; }
        
        /* Responsive */
        @media (max-width: 1200px) { .main-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { 
            .container { padding: 10px; }
            .header { padding: 20px; }
            .header h1 { font-size: 24px; }
            .card { padding: 20px; }
        }
    </style>
</head>
<body>
    <!-- Email Verification Overlay -->
    <div id="emailOverlay" class="email-overlay">
        <div class="email-box">
            <h2>üîí Email Verification</h2>
            <p>Please enter your Bureau Veritas email to access the system</p>
            <input type="email" id="emailInput" class="email-input" placeholder="your.name@bureauveritas.com" />
            <button class="btn-verify" onclick="verifyEmail()">Verify Email</button>
            <p id="errorMsg" class="error-msg">‚ùå Access denied. Please use a valid @bureauveritas.com email address.</p>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                üìÑ Document & Transmittal Generator
                <span id="verifiedBadge" class="verified-badge" style="display:none;">‚úì Verified</span>
            </h1>
            <p>ENI Project - Provision of Technical and Process Safety Studies, Assessment and Support Services</p>
            <p class="user-info">Logged in as: <strong id="userEmail"></strong></p>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- LEFT: Input Parameters -->
            <div class="card">
                <h2>üìù Input Parameters</h2>
                
                <div class="form-group">
                    <label>Contract *</label>
                    <select id="contract" required>
                        <option value="" disabled selected>-- Select Contract --</option>
                        <option value="5000024873">5000024873 - Eni Muara Bakau B.V</option>
                        <option value="5000024862">5000024862 - Eni East Ganal Ltd.</option>
                        <option value="5000024861">5000024861 - Eni East Sepinggan Ltd.</option>
                        <option value="5000024863">5000024863 - Eni North Ganal Ltd.</option>
                        <option value="5000024864">5000024864 - Eni West Ganal Ltd.</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Sub-Facility *</label>
                    <select id="subFacility" onchange="updateCategory()" required>
                        <option value="" disabled selected>-- Select Sub-Facility --</option>
                        <option value="00">00 - General / Others</option>
                        <option value="01">01 - FPU</option>
                        <option value="02">02 - RFI</option>
                        <option value="03">03 - SPS</option>
                        <option value="04">04 - JKK - Telcom System Caprock</option>
                        <option value="05">05 - JKK - Telcom Rental Equipt Compnet</option>
                        <option value="06">06 - JKK - Telcom Rental Jasnikom</option>
                        <option value="10">10 - JKK - GnG Merakes / Merakes EPCI-1</option>
                        <option value="11">11 - MERAKES EPCI-4</option>
                        <option value="12">12 - MERAKES EP-3 / MERAKES EPCI-2</option>
                        <option value="13">13 - Telford (MKS EPCI-1)</option>
                        <option value="14">14 - Maha</option>
                        <option value="20">20 - Merakes East</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Phase *</label>
                    <select id="phase" required>
                        <option value="" disabled selected>-- Select Phase --</option>
                        <option value="F">F - Feasibility Study</option>
                        <option value="B">B - Basic / FEED</option>
                        <option value="C">C - Construction</option>
                        <option value="D">D - Detail</option>
                        <option value="P">P - Production</option>
                        <option value="G">G - Decommissioning</option>
                        <option value="H">H - Abandonment</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Discipline *</label>
                    <select id="discipline" required>
                        <option value="" disabled selected>-- Select Discipline --</option>
                        <option value="A">A - Civil & Architectural</option>
                        <option value="B">B - Quality Assurance & Control</option>
                        <option value="C">C - Telecommunications</option>
                        <option value="D">D - Reserved</option>
                        <option value="E">E - Electrical</option>
                        <option value="F">F - HSE (Health Safety & Environmental)</option>
                        <option value="G">G - Interdiscipline & Miscellaneous</option>
                        <option value="H">H - Logistic</option>
                        <option value="I">I - Instrumentation, Control & Automation</option>
                        <option value="J">J - Construction & Erection/Installation</option>
                        <option value="K">K - Maintenance</option>
                        <option value="L">L - Pipeline</option>
                        <option value="M">M - Machinery Packages</option>
                        <option value="N">N - Naval & Floating Platform</option>
                        <option value="O">O - Offshore Fixed Platform</option>
                        <option value="P">P - Process</option>
                        <option value="Q">Q - Reserved</option>
                        <option value="R">R - Research & Technological Innovation</option>
                        <option value="S">S - Offshore Pipelines (Sealines)</option>
                        <option value="T">T - Plant Layout & Piping</option>
                        <option value="U">U - Subsea Systems</option>
                        <option value="V">V - Mechanical Equipment</option>
                        <option value="W">W - Commissioning and Test Run</option>
                        <option value="X">X - Material, Corrosion, Welding, Painting & Insulation</option>
                        <option value="Y">Y - Marine</option>
                        <option value="Z">Z - Decommissioning</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Document Category *</label>
                    <select id="docCategory" onchange="updateDocTypeOptions()" required>
                        <option value="" disabled selected>-- Select Document Category --</option>
                        <option value="C">C - Calculations</option>
                        <option value="D">D - Drawing to Scale</option>
                        <option value="E">E - Lists</option>
                        <option value="F">F - Diagram</option>
                        <option value="G">G - Data Sheets</option>
                        <option value="L">L - Documents for Authorization</option>
                        <option value="M">M - Handbooks</option>
                        <option value="P">P - Procedures, Plans and Programmes</option>
                        <option value="Q">Q - Quality</option>
                        <option value="R">R - Report</option>
                        <option value="S">S - Specifications</option>
                        <option value="T">T - Software</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Document Type *</label>
                    <select id="docType" disabled required>
                        <option value="" disabled selected>-- Select Category First --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Revision Status *</label>
                    <select id="revStatus" required>
                        <option value="" disabled selected>-- Select Revision Status --</option>
                        <option value="EV-FS">EV-FS - Evaluation for Feasibility Study</option>
                        <option value="CS-FS">CS-FS - Concept Selection for Feasibility Study</option>
                        <option value="CD-BF">CD-BF - Concept Definition for Basic</option>
                        <option value="CD-FE">CD-FE - Concept Definition for Feed</option>
                        <option value="EX-DE">EX-DE - Execution for Detail</option>
                        <option value="EX-CO">EX-CO - Execution for Construction</option>
                        <option value="EX-AB">EX-AB - Execution As Built</option>
                        <option value="PR-CO">PR-CO - Production Commissioning</option>
                        <option value="PR-OP">PR-OP - Production Operation</option>
                        <option value="PD-DF">PD-DF - Decommissioning Project Definition</option>
                        <option value="PE-DT">PE-DT - Decommissioning Project Execution - Detail</option>
                        <option value="PE-DI">PE-DI - Decommissioning Project Execution - Removal</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Description Status *</label>
                    <select id="descStatus" onchange="updateRevisionNumber()" required>
                        <option value="" disabled selected>-- Select Description Status --</option>
                        <option value="IFI">IFI - Issued for Information</option>
                        <option value="IFR">IFR - Issued for Review</option>
                        <option value="Re-IFR">Re-IFR - Re-Issued for Review</option>
                        <option value="IFA">IFA - Issued for Approval</option>
                        <option value="Re-IFA">Re-IFA - Re-Issued for Approval</option>
                        <option value="Final">Final Issue</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Revision Number *</label>
                    <input type="text" id="revNumber" placeholder="00" maxlength="2" pattern="[0-9]{2}" required />
                    <small style="color: #6c757d; font-size: 12px;">Auto-filled for IFI/IFR (00), manual input for others (01, 02, 03...)</small>
                </div>

                <div class="form-group">
                    <label>Page Count *</label>
                    <input type="number" id="pageCount" placeholder="e.g. 24" min="1" required />
                </div>

                <div class="form-group">
                    <label>Internal Category</label>
                    <select id="category" required>
                        <option value="" disabled selected>-- Auto-filled from Sub-Facility --</option>
                        <option value="A">A - Kadal</option>
                        <option value="B">B - Merakes East</option>
                        <option value="C">C - Jangkrik North East (JNE)</option>
                        <option value="D">D - Konta</option>
                        <option value="E">E - Merakes-4 (MKS-4)</option>
                        <option value="F">F - Merakes-7 (MKS-7)</option>
                        <option value="G">G - Maha</option>
                        <option value="H">H - Eni Muara Bakau B.V.</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Document Title *</label>
                    <textarea id="docTitle" placeholder="Enter complete document description (e.g., Kadal Exploration Drilling - Terms of Reference (TOR) for HAZID Exploration Drilling and HAZOP Landing String for Kadal-1)" required></textarea>
                </div>

                <button class="btn btn-preview" onclick="preview()">üîç Preview Document Numbers</button>
                <button id="confirmBtn" class="btn btn-confirm" onclick="confirmAndSave()">‚úÖ Confirm & Save to Database</button>
            </div>

            <!-- RIGHT: Generated Outputs -->
            <div class="card">
                <h2>üìã Generated Outputs</h2>
                
                <div id="previewBadge" class="preview-badge">
                    ‚ö†Ô∏è PREVIEW MODE - Numbers not saved yet. Click "Confirm & Save" to record to database.
                </div>
                
                <div class="output-card">
                    <h3>Document Name</h3>
                    <div class="output-display">
                        <input type="text" id="out1" readonly placeholder="Will be generated after preview...">
                        <button class="copy-btn" onclick="copy(1)">üìã Copy</button>
                    </div>
                    <div id="msg1" class="success"></div>
                </div>

                <div class="output-card">
                    <h3>File Name for Client</h3>
                    <div class="output-display">
                        <input type="text" id="out2" readonly placeholder="Will be generated after preview...">
                        <button class="copy-btn" onclick="copy(2)">üìã Copy</button>
                    </div>
                    <div id="msg2" class="success"></div>
                </div>

                <div class="output-card">
                    <h3>Internal Document Numbering</h3>
                    <div class="output-display">
                        <input type="text" id="out3" readonly placeholder="Will be generated after preview...">
                        <button class="copy-btn" onclick="copy(3)">üìã Copy</button>
                    </div>
                    <div id="msg3" class="success"></div>
                </div>

                <div class="info-card">
                    <h3>üí° How It Works</h3>
                    <p>
                        ‚Ä¢ <strong>Preview</strong> - Check your document numbers before saving<br>
                        ‚Ä¢ <strong>Confirm & Save</strong> - Records to database & increments counter<br>
                        ‚Ä¢ <strong>Auto-generates</strong> - Transmittal entry created automatically<br>
                        ‚Ä¢ <strong>No duplicates</strong> - Counter only increments after confirmation
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_URL = 'https://script.google.com/macros/s/AKfycby9cO6NONVBf6z5Ze43RK4bsCYfH2z_VPgDvXIUwfg7ei9pymMwbD6dC58jYPojyGPIGA/exec';
        
        // State
        let counters = {A:7, B:7, C:3, D:5, E:9, F:6, G:5, H:1};
        let isPreviewMode = false;
        let userEmail = '';
        let isVerified = false;
        let isLoading = false;
        
        // Contract Mapping
        const contractMap = {
            '5000024873': 'Eni Muara Bakau B.V',
            '5000024862': 'Eni East Ganal Ltd.',
            '5000024861': 'Eni East Sepinggan Ltd.',
            '5000024863': 'Eni North Ganal Ltd.',
            '5000024864': 'Eni West Ganal Ltd.'
        };
        
        // Document Type Options (FULL - 160+ types)
        const docTypeOptions = {
            'C': [
                {code: 'CA', name: 'Generic Calculation'},
                {code: 'CB', name: 'Calculation Procedure'},
                {code: 'CC', name: 'Calculation of Reinforced Concrete Foundations'},
                {code: 'CD', name: 'Design Calculation'},
                {code: 'CE', name: 'Electrical Calculation'},
                {code: 'CF', name: 'Reliability Availability Maintainability (RAM) Analysis'},
                {code: 'CG', name: 'PSV Calculation & Sizing'},
                {code: 'CH', name: 'Calculation of Air Conditioning, Ventilation and Heating'},
                {code: 'CI', name: 'Instrumentation Calculation Sheet'},
                {code: 'CP', name: 'Pipeline Structural, Hydraulic and Corrosion Analysis'},
                {code: 'CS', name: 'Stress Analysis and Structural Calculation'},
                {code: 'CT', name: 'Metrical Computation'},
                {code: 'CV', name: 'Failure Mode Effects (FMEA) and RCM Analysis'},
                {code: 'CW', name: 'Fatigue Analysis'},
                {code: 'CX', name: 'Stability Analysis'},
                {code: 'CY', name: 'Transportation Analysis'},
                {code: 'CZ', name: 'Analysis (Based on Calculation)'}
            ],
            'D': [
                {code: 'DA', name: 'Equipment, Assembly and Outline Drawings'},
                {code: 'DB', name: 'Drawing of Reinforced Concrete Structure, Foundations'},
                {code: 'DC', name: 'Construction Drawing of Equipment'},
                {code: 'DD', name: 'Layout Diagram'},
                {code: 'DE', name: 'Drawing of Steel Structures'},
                {code: 'DF', name: 'Drawing of Subfoundations'},
                {code: 'DG', name: 'Key Plan / Plot Plan'},
                {code: 'DH', name: 'Drawing of Hazardous Area Classification'},
                {code: 'DI', name: 'Isometric Drawing'},
                {code: 'DL', name: 'Routing Layout / Route Drawing'},
                {code: 'DM', name: 'Architectural Drawing'},
                {code: 'DN', name: 'Pipeline, Sealine Drawing'},
                {code: 'DP', name: 'General Arrangement / Arrangement'},
                {code: 'DQ', name: 'Typical Detail Drawing'},
                {code: 'DR', name: 'Instrument, Location & Installation Arrangement'},
                {code: 'DS', name: 'Utility Drawing'},
                {code: 'DT', name: 'Soil Arrangement and Earth Works Drawing'},
                {code: 'DU', name: 'Interface Drawings'},
                {code: 'DV', name: 'Underground Distribution and Crossing'},
                {code: 'DW', name: 'Hook Up Drawing'},
                {code: 'DX', name: 'Map'},
                {code: 'DZ', name: '3D Models'}
            ],
            'E': [
                {code: 'EA', name: 'Equipment List'},
                {code: 'EB', name: 'Material Take Off'},
                {code: 'EC', name: 'Bar List'},
                {code: 'ED', name: 'Deliverable/Document List'},
                {code: 'EE', name: 'Input/Output List'},
                {code: 'EF', name: 'Facility Functional Unit List'},
                {code: 'EG', name: 'Packing List'},
                {code: 'EH', name: 'Loop, Instrument and Function Unit List'},
                {code: 'EI', name: 'Interconnection Table, Wiring Diagram, Board Terminal List'},
                {code: 'EJ', name: 'Requisition List'},
                {code: 'EK', name: 'Systemization for Project Completion'},
                {code: 'EL', name: 'Line List, Tie-In List, Fluid List, Support List'},
                {code: 'EM', name: 'Erection Material List'},
                {code: 'EN', name: 'Action List'},
                {code: 'EO', name: 'General List/Register/Summary'},
                {code: 'EP', name: 'Cable and Cableway List'},
                {code: 'EQ', name: 'Cause-Effect Table'},
                {code: 'ER', name: 'Wall Crossing Table (Cable Passages), Penetration List'},
                {code: 'ES', name: 'Tender Document List'},
                {code: 'ET', name: 'Structural Material List'},
                {code: 'EU', name: 'Electrical Load List'},
                {code: 'EV', name: 'Valve List'},
                {code: 'EW', name: 'Utilities List and Consumption Summary'},
                {code: 'EX', name: 'Software List'},
                {code: 'EY', name: 'Contractor List'},
                {code: 'EZ', name: 'Bill of Materials'}
            ],
            'F': [
                {code: 'FA', name: 'General Diagram'},
                {code: 'FB', name: 'Block Diagram'},
                {code: 'FC', name: 'Logic Diagram'},
                {code: 'FD', name: 'Organization Chart'},
                {code: 'FE', name: 'Pneumatic Connection Diagram'},
                {code: 'FF', name: 'Schematic Diagram'},
                {code: 'FI', name: 'Wiring Diagram'},
                {code: 'FL', name: 'Loop Diagram'},
                {code: 'FM', name: 'Piping and Instrumentation Diagram (P&ID)'},
                {code: 'FP', name: 'Termination and Connection Diagram and Junction Box Diagram'},
                {code: 'FQ', name: 'Process Flow Diagram'},
                {code: 'FR', name: 'Marked-Up Drawings for Commissioning Purposes'},
                {code: 'FS', name: 'Functional Diagram for Safety Devices'},
                {code: 'FT', name: 'Marked-Up Drawings'},
                {code: 'FU', name: 'Electrical One-Line Diagram'}
            ],
            'G': [
                {code: 'GA', name: 'Supplementary Technical Specification, Data Sheet'},
                {code: 'GB', name: 'Inspection Data Sheet (IDS)'},
                {code: 'GC', name: 'Required Document Data Sheet (RDDS)'},
                {code: 'GD', name: 'Material Safety Data Sheet (MSDS)'}
            ],
            'L': [
                {code: 'LA', name: 'Application for Legal Authorization'},
                {code: 'LB', name: 'Technical Report for Authorities'}
            ],
            'M': [
                {code: 'MA', name: 'Handbook and Manual'},
                {code: 'MC', name: 'Data Book/Dossier'},
                {code: 'MF', name: 'Final Data Book'},
                {code: 'MI', name: 'Installation/Maintenance Handbook'},
                {code: 'MO', name: 'Operation Handbook'},
                {code: 'MP', name: 'Design Handbook'},
                {code: 'MR', name: 'Manufacturer Record Book'},
                {code: 'MS', name: 'Safety Handbook'}
            ],
            'P': [
                {code: 'PA', name: 'Safety Plan'},
                {code: 'PB', name: 'Commissioning Plans and Procedures'},
                {code: 'PC', name: 'Construction Plan'},
                {code: 'PD', name: 'Design Plan'},
                {code: 'PE', name: 'Security Plan'},
                {code: 'PF', name: 'Procurement Plan'},
                {code: 'PG', name: 'Managing Procedure'},
                {code: 'PH', name: 'Commissioning Strategy'},
                {code: 'PI', name: 'Test Procedure'},
                {code: 'PJ', name: 'Method of Statement'},
                {code: 'PK', name: 'Installation Plan, Analysis and Procedures'},
                {code: 'PL', name: 'Activity Plan'},
                {code: 'PP', name: 'Facility Plan'},
                {code: 'PQ', name: 'General Plan'},
                {code: 'PR', name: 'Project Schedule'},
                {code: 'PS', name: 'Project Plan'},
                {code: 'PT', name: 'Technical Procedure'},
                {code: 'PU', name: 'Technical Guideline, Philosophy, Strategy and Criteria'},
                {code: 'PV', name: 'Maintenance Guideline, Procedure'}
            ],
            'Q': [
                {code: 'QA', name: 'Project Quality Plan'},
                {code: 'QB', name: 'Quality Control Plan, Inspection and Test Plan'},
                {code: 'QC', name: 'Quality Control Manual'},
                {code: 'QE', name: 'Certifying Documentation File'},
                {code: 'QF', name: 'Release Note'},
                {code: 'QG', name: 'Audit Program/Plan'},
                {code: 'QI', name: 'Inspection Report'},
                {code: 'QJ', name: 'Risk Assessment'},
                {code: 'QK', name: 'Risk Identification and Management'},
                {code: 'QL', name: 'Expediting Reports'},
                {code: 'QN', name: 'Non Conformity Report'},
                {code: 'QR', name: 'Quality Requirement, Procedure, Specification'},
                {code: 'QS', name: 'Vendor, Supplier Qualification'},
                {code: 'QV', name: 'Emergency Response Strategy'},
                {code: 'QW', name: 'HSE Plan'},
                {code: 'QX', name: 'HSE Philosophy'},
                {code: 'QY', name: 'Impact Assessment'}
            ],
            'R': [
                {code: 'RA', name: 'Technical Study'},
                {code: 'RB', name: 'Project/Design Premises/Bases Report-Philosophy Report'},
                {code: 'RC', name: 'Technical Assessment - Design Review'},
                {code: 'RD', name: 'Supplier Technical Qualification'},
                {code: 'RE', name: 'As Built Report'},
                {code: 'RF', name: 'Feasibility Study of Facility'},
                {code: 'RG', name: 'Engineering Cost Estimate Report (Miscellaneous)'},
                {code: 'RH', name: 'Design Report'},
                {code: 'RI', name: 'HAZID / HAZOP Report'},
                {code: 'RJ', name: 'General Assessment'},
                {code: 'RK', name: 'Safety and Environmental Critical Elements (SECE)'},
                {code: 'RS', name: 'Survey/Inspection Report'},
                {code: 'RT', name: 'Test Report'},
                {code: 'RU', name: 'Technical Appraisal of Bid'},
                {code: 'RV', name: 'General Report'},
                {code: 'RW', name: 'Conformity Declaration, Verification Report'},
                {code: 'RX', name: 'Material Tracking, Supply Chain Report'},
                {code: 'RZ', name: 'Progress Report'}
            ],
            'S': [
                {code: 'SA', name: 'Construction Specification'},
                {code: 'SB', name: 'Commissioning Specification'},
                {code: 'SC', name: 'Scope of Work of Contract Variation and Change Order'},
                {code: 'SD', name: 'Piping Specification'},
                {code: 'SF', name: 'Supply Specification, Requisition'},
                {code: 'SG', name: 'General Specification'},
                {code: 'SH', name: 'Functional Specification'},
                {code: 'SP', name: 'Facility Specification'},
                {code: 'SS', name: 'Survey/Inspection Specification'},
                {code: 'ST', name: 'Technical Specification'}
            ],
            'T': [
                {code: 'TA', name: 'Software Specification'},
                {code: 'TB', name: 'Software Functional Specification'},
                {code: 'TC', name: 'Software User Manual'},
                {code: 'TD', name: 'Software Installation Manual'},
                {code: 'TE', name: 'Software Maintenance Manual'},
                {code: 'TF', name: 'Source Program'},
                {code: 'TG', name: 'List of Video Screens'},
                {code: 'TH', name: 'Software Tools Set-Up'},
                {code: 'TS', name: 'Survey Raw Data'},
                {code: 'TT', name: 'Model or Database'},
                {code: 'TZ', name: '2D/3D Model Database'}
            ]
        };
        
        // Email Verification
        function verifyEmail() {
            const email = document.getElementById('emailInput').value.trim().toLowerCase();
            const errorMsg = document.getElementById('errorMsg');
            
            if (email.endsWith('@bureauveritas.com')) {
                userEmail = email;
                isVerified = true;
                document.getElementById('emailOverlay').style.display = 'none';
                document.getElementById('verifiedBadge').style.display = 'inline-block';
                document.getElementById('userEmail').textContent = userEmail;
                sessionStorage.setItem('verifiedEmail', userEmail);
                loadCounters();
            } else {
                errorMsg.style.display = 'block';
                setTimeout(() => errorMsg.style.display = 'none', 3000);
            }
        }
        
        // Check stored email on load
        window.onload = function() {
            const stored = sessionStorage.getItem('verifiedEmail');
            if (stored && stored.endsWith('@bureauveritas.com')) {
                userEmail = stored;
                isVerified = true;
                document.getElementById('emailOverlay').style.display = 'none';
                document.getElementById('verifiedBadge').style.display = 'inline-block';
                document.getElementById('userEmail').textContent = userEmail;
                loadCounters();
            }
        };
        
        // Load counters from API
        async function loadCounters() {
            try {
                const response = await fetch(`${API_URL}?action=getCounters`);
                const result = await response.json();
                if (result.success && result.data) {
                    counters = result.data;
                    console.log('Counters loaded:', counters);
                }
            } catch (error) {
                console.warn('Using fallback counters:', error);
            }
        }
        
        // Update category based on sub-facility
        function updateCategory() {
            const sf = document.getElementById('subFacility').value;
            const map = {'20':'B', '11':'E', '14':'G'};
            const cat = map[sf] || 'A';
            document.getElementById('category').value = cat;
        }
        
        // Update document type options based on category
        function updateDocTypeOptions() {
            const category = document.getElementById('docCategory').value;
            const docTypeSelect = document.getElementById('docType');
            
            docTypeSelect.innerHTML = '<option value="" disabled selected>-- Select Document Type --</option>';
            
            if (category && docTypeOptions[category]) {
                docTypeSelect.disabled = false;
                docTypeOptions[category].forEach(doc => {
                    const option = document.createElement('option');
                    option.value = doc.code;
                    option.textContent = `${doc.code} - ${doc.name}`;
                    docTypeSelect.appendChild(option);
                });
            } else {
                docTypeSelect.disabled = true;
            }
        }
        
        // Update revision number based on description status
        function updateRevisionNumber() {
            const descStatus = document.getElementById('descStatus').value;
            const revNumInput = document.getElementById('revNumber');
            
            if (descStatus === 'IFI' || descStatus === 'IFR') {
                revNumInput.value = '00';
                revNumInput.disabled = true;
                revNumInput.style.background = '#e9ecef';
                revNumInput.style.color = '#6c757d';
            } else {
                if (revNumInput.value === '00') {
                    revNumInput.value = '';
                }
                revNumInput.disabled = false;
                revNumInput.style.background = 'white';
                revNumInput.style.color = '#212529';
                revNumInput.placeholder = 'e.g. 01';
            }
        }
        
        // Preview function
        function preview() {
            if (!isVerified) {
                alert('‚ö†Ô∏è Please verify your email first!');
                return;
            }
            
            // Get all values
            const contract = document.getElementById('contract').value;
            const sf = document.getElementById('subFacility').value;
            const ph = document.getElementById('phase').value;
            const ds = document.getElementById('discipline').value;
            const dt = document.getElementById('docType').value;
            const revStatus = document.getElementById('revStatus').value;
            const descStatus = document.getElementById('descStatus').value;
            const revNum = document.getElementById('revNumber').value;
            const pg = document.getElementById('pageCount').value;
            const cat = document.getElementById('category').value;
            const title = document.getElementById('docTitle').value.trim();
            
            // Validation
            if(!contract || !sf || !ph || !ds || !dt || !revStatus || !descStatus || !revNum || !pg || !cat || !title) {
                alert('‚ö†Ô∏è Please fill in all required fields!');
                return;
            }
            
            if (!/^[0-9]{2}$/.test(revNum)) {
                alert('‚ö†Ô∏è Revision Number must be 2 digits (e.g., 00, 01, 02)');
                return;
            }
            
            // Generate preview
            const nextNum = counters[cat] + 1;
            const docNum = `2208${sf}${ph}${ds}${dt}00001`;
            const revStatusCode = revStatus.replace('-', '');
            const fileName = `${docNum}_${revStatusCode}${revNum}_${pg}.pdf`;
            const internal = `IN-2208-${sf}-P0Y-ENI-${cat}${String(nextNum).padStart(4,'0')}`;
            
            // Display outputs
            document.getElementById('out1').value = docNum;
            document.getElementById('out2').value = fileName;
            document.getElementById('out3').value = internal;
            
            // Show preview mode
            document.getElementById('previewBadge').style.display = 'block';
            document.getElementById('confirmBtn').style.display = 'block';
            isPreviewMode = true;
            
            alert('üîç Preview Generated!\n\nReview the document numbers on the right.\nClick "Confirm & Save" if everything is correct.');
        }
        
        // Confirm and save
        async function confirmAndSave() {
            if (!isPreviewMode) {
                alert('‚ö†Ô∏è Please preview first!');
                return;
            }
            
            if (!isVerified) {
                alert('‚ö†Ô∏è Please verify your email first!');
                return;
            }
            
            if (isLoading) {
                alert('‚è≥ Please wait, saving...');
                return;
            }
            
            const confirmBtn = document.getElementById('confirmBtn');
            const originalText = confirmBtn.textContent;
            confirmBtn.textContent = '‚è≥ Saving to Database...';
            confirmBtn.disabled = true;
            isLoading = true;
            
            try {
                const cat = document.getElementById('category').value;
                const sf = document.getElementById('subFacility').value;
                const contract = document.getElementById('contract').value;
                
                // Build data
                const formData = {
                    action: 'generate',
                    email: userEmail,
                    contract: contract,
                    contractCompany: contractMap[contract],
                    subFacility: sf,
                    phase: document.getElementById('phase').value,
                    discipline: document.getElementById('discipline').value,
                    docType: document.getElementById('docType').value,
                    revStatus: document.getElementById('revStatus').value,
                    descStatus: document.getElementById('descStatus').value,
                    revNumber: document.getElementById('revNumber').value,
                    pageCount: document.getElementById('pageCount').value,
                    category: cat,
                    docTitle: document.getElementById('docTitle').value
                };
                
                // Send via GET (no-cors workaround)
                const url = `${API_URL}?` + Object.keys(formData).map(k => 
                    `${k}=${encodeURIComponent(formData[k])}`
                ).join('&');
                
                const img = new Image();
                img.src = url;
                
                // Wait for request to send
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Update local counter
                counters[cat]++;
                
                // Get generated numbers
                const docNum = document.getElementById('out1').value;
                const fileName = document.getElementById('out2').value;
                const internal = document.getElementById('out3').value;
                
                // Hide preview mode
                document.getElementById('previewBadge').style.display = 'none';
                confirmBtn.style.display = 'none';
                isPreviewMode = false;
                
                // Success message
                alert(`‚úÖ Document Generated Successfully\n\nInternal Number: ${internal}\nGenerated by: ${userEmail}\n\nAll numbers have been recorded.\n\nTransmittal entry created automatically.`);
                
                // Reset form (optional)
                // document.querySelectorAll('input, select, textarea').forEach(el => {
                //     if (!['contract', 'subFacility', 'category'].includes(el.id)) el.value = '';
                // });
                
            } catch (error) {
                console.error('Error:', error);
                alert(`‚ùå Error saving to database\n\nPlease try again or contact admin.`);
            } finally {
                isLoading = false;
                confirmBtn.textContent = originalText;
                confirmBtn.disabled = false;
            }
        }
        
        // Copy to clipboard
        function copy(n) {
            const inp = document.getElementById('out' + n);
            if (!inp.value) {
                alert('‚ö†Ô∏è Generate numbers first!');
                return;
            }
            
            inp.select();
            document.execCommand('copy');
            
            const msg = document.getElementById('msg' + n);
            msg.textContent = '‚úì Copied to clipboard!';
            setTimeout(() => msg.textContent = '', 2000);
        }
        
        // Enter key shortcuts
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.id === 'pageCount' && !isPreviewMode) {
                preview();
            }
        });
    </script>
</body>
</html>
